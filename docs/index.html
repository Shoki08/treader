<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coincheck AI</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        /* LINE風デザイン定義 */
        :root {
            --bg-color: #f2f4f8; /* LINEのトーク背景っぽい薄いグレー */
            --header-bg: #ffffff;
            --primary: #06c755; /* LINE Green */
            --text-main: #111111;
            --text-sub: #888888;
            --card-bg: #ffffff;
            --danger: #eb4d3d;
        }
        body {
            background: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            margin: 0;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* ヘッダーまわり */
        header {
            background: var(--header-bg);
            padding: 15px 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        h1 {
            margin: 0;
            font-size: 16px;
            color: var(--text-main);
            font-weight: bold;
        }
        .updated {
            font-size: 10px;
            color: var(--text-sub);
            margin-top: 4px;
        }

        /* モード切り替えタブ */
        .mode-tabs {
            display: flex;
            justify-content: center;
            padding: 10px;
            background: var(--header-bg);
            border-bottom: 1px solid #eee;
        }
        .tab-btn {
            flex: 1;
            max-width: 150px;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            border-radius: 20px;
            margin: 0 5px;
            cursor: pointer;
            transition: 0.2s;
            background: #eee;
            color: var(--text-sub);
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .section-label {
            font-size: 12px;
            color: var(--text-sub);
            margin: 20px 0 8px 5px;
        }

        /* ポートフォリオカード */
        .portfolio-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .p-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .p-name { font-weight: bold; font-size: 16px; }
        .p-profit { font-weight: bold; font-size: 18px; }
        .plus { color: var(--primary); }
        .minus { color: var(--danger); }
        .p-meta { font-size: 11px; color: var(--text-sub); }
        .sell-badge {
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 10px;
            animation: pulse 1.5s infinite;
            align-self: flex-start;
            margin-top: 8px;
        }

        /* コインリスト */
        .coin-item {
            background: var(--card-bg);
            padding: 12px 16px;
            margin-bottom: 1px; /* LINEのリストっぽく */
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .coin-item:first-child { border-radius: 12px 12px 0 0; }
        .coin-item:last-child { border-radius: 0 0 12px 12px; margin-bottom: 20px; }
        
        .c-info { display: flex; flex-direction: column; }
        .c-sym { font-weight: bold; font-size: 15px; color: var(--text-main); }
        .c-price { font-size: 12px; color: var(--text-sub); margin-top: 2px; }
        
        .c-badge {
            font-size: 11px;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            text-align: center;
            min-width: 70px;
        }

        /* 追加ボタン */
        .fab {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            color: white;
            box-shadow: 0 4px 12px rgba(6, 199, 85, 0.4);
            cursor: pointer;
            z-index: 999;
        }

        /* モーダル */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-box {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 85%;
            max-width: 320px;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 5px; }
        input, select {
            width: 100%; padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background: #f9f9f9;
        }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-save { background: var(--primary); color: white; }
        .btn-close { background: #eee; color: #666; }
        .btn-del { background: #fff0f0; color: var(--danger); margin-top: 10px; width: 100%; padding: 10px; font-size: 12px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <header>
        <h1>Coincheck AI</h1>
        <div class="updated" id="last-updated">更新中...</div>
    </header>

    <div class="mode-tabs">
        <div class="tab-btn active" id="btn-short" onclick="setMode('short')">短期 (デイトレ)</div>
        <div class="tab-btn" id="btn-long" onclick="setMode('long')">長期 (ガチホ)</div>
    </div>

    <div class="container">
        <div class="section-label">保有資産 (Portfolio)</div>
        <div id="portfolio-list">
            <div style="text-align:center; padding:20px; font-size:12px; color:#888;">
                右下の＋ボタンから<br>購入したコインを登録できます
            </div>
        </div>

        <div class="section-label">全35銘柄 AI分析</div>
        <div id="market-list">
            <div style="text-align:center; padding:20px; font-size:12px; color:#888;">読み込み中...</div>
        </div>
    </div>

    <div class="fab" onclick="openModal()">＋</div>

    <div class="modal" id="modal">
        <div class="modal-box">
            <h3 style="margin-top:0; font-size:16px; text-align:center;">購入データを入力</h3>
            <div class="form-group">
                <label>コインを選択</label>
                <select id="inp-sym"></select>
            </div>
            <div class="form-group">
                <label>買った時の価格 (1枚あたり)</label>
                <input type="number" id="inp-rate" placeholder="例: 5000000">
            </div>
            <div class="form-group">
                <label>買った金額 (日本円)</label>
                <input type="number" id="inp-yen" placeholder="例: 30000">
            </div>
            <div class="btn-row">
                <button class="btn-close" onclick="closeModal()">キャンセル</button>
                <button class="btn-save" onclick="saveData()">保存</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'short'; // 'short' or 'long'
        let marketData = {};
        let myData = JSON.parse(localStorage.getItem('cc_positions')) || [];

        async function init() {
            try {
                const ts = new Date().getTime();
                const res = await fetch(`data/crypto_signal.json?t=${ts}`);
                const json = await res.json();
                marketData = json.data;
                document.getElementById('last-updated').innerText = `最終更新: ${json.updated}`;
                
                renderMarket();
                renderPortfolio();
                setupSelect();
            } catch (e) {
                console.error(e);
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-short').className = `tab-btn ${mode==='short'?'active':''}`;
            document.getElementById('btn-long').className = `tab-btn ${mode==='long'?'active':''}`;
            renderMarket();
        }

        function renderMarket() {
            const list = document.getElementById('market-list');
            if (Object.keys(marketData).length === 0) return;

            let html = '';
            // 銘柄リスト生成
            Object.keys(marketData).forEach(sym => {
                const d = marketData[sym];
                const analysis = d[currentMode]; // 選択中のモードのデータを取得
                
                if (!analysis) return;

                // LINE風リストアイテム
                html += `
                <div class="coin-item" onclick="prefill('${sym}')">
                    <div class="c-info">
                        <span class="c-sym">${sym}</span>
                        <span class="c-price">現在: ¥${d.price.toLocaleString()}</span>
                    </div>
                    <div class="c-badge" style="background:${analysis.color}">
                        ${analysis.signal}
                    </div>
                </div>`;
            });
            list.innerHTML = html;
        }

        function renderPortfolio() {
            const list = document.getElementById('portfolio-list');
            if (myData.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; font-size:12px; color:#888;">右下の＋ボタンから<br>購入したコインを登録できます</div>';
                return;
            }

            let html = '';
            myData.forEach((pos, idx) => {
                const market = marketData[pos.symbol];
                if (!market) return;
                
                // 利益計算
                const amount = pos.yen / pos.buyRate;
                const val = amount * market.price;
                const profit = val - pos.yen;
                
                const sign = profit >= 0 ? '+' : '';
                const colorClass = profit >= 0 ? 'plus' : 'minus';
                
                // 売りアラート（モードに関係なく、AIが売りと言っていて利益が出ていれば出す）
                // ※ここでは「短期」のシグナルを優先してアラート判定します
                const sig = market.short.signal;
                let alertHtml = '';
                if (sig.includes('売り') && profit > 0) {
                    alertHtml = `<div class="sell-badge">利確チャンス！ (${market.short.msg})</div>`;
                }

                html += `
                <div class="portfolio-card">
                    <div class="p-row">
                        <span class="p-name">${pos.symbol}</span>
                        <span class="p-profit ${colorClass}">${sign}¥${Math.floor(profit).toLocaleString()}</span>
                    </div>
                    <div class="p-row">
                        <span class="p-meta">取得: ¥${pos.buyRate.toLocaleString()} / 投資: ¥${pos.yen.toLocaleString()}</span>
                    </div>
                    ${alertHtml}
                    <button class="btn-del" style="background:transparent; border:none; text-align:right; width:auto; margin:0; padding:0;" onclick="delData(${idx})">削除</button>
                </div>`;
            });
            list.innerHTML = html;
        }

        function setupSelect() {
            const sel = document.getElementById('inp-sym');
            let opts = '';
            Object.keys(marketData).forEach(s => {
                opts += `<option value="${s}">${s}</option>`;
            });
            sel.innerHTML = opts;
        }

        // モーダル関連
        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function prefill(sym) {
            document.getElementById('inp-sym').value = sym;
            openModal();
        }

        function saveData() {
            const s = document.getElementById('inp-sym').value;
            const r = document.getElementById('inp-rate').value;
            const y = document.getElementById('inp-yen').value;
            if(!s || !r || !y) return alert("入力を確認してください");
            
            myData.push({ symbol: s, buyRate: parseFloat(r), yen: parseFloat(y) });
            localStorage.setItem('cc_positions', JSON.stringify(myData));
            closeModal();
            renderPortfolio();
        }

        function delData(idx) {
            if(confirm("削除しますか？")) {
                myData.splice(idx, 1);
                localStorage.setItem('cc_positions', JSON.stringify(myData));
                renderPortfolio();
            }
        }

        init();
    </script>
</body>
</html>
