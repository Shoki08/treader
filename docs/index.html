<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coincheck AI Final</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root { --bg:#f0f2f5; --card:#fff; --text:#1c1e21; --green:#06c755; --red:#ff3b30; --blue:#007aff; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        .market-panel { background: #1c1e21; color: white; padding: 20px 15px 15px; border-radius: 0 0 20px 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .mp-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .mp-label { font-size: 12px; opacity: 0.8; }
        .mp-val { font-weight: bold; font-size: 18px; }
        .fng-bar { height: 6px; background: #333; border-radius: 3px; margin-top: 8px; overflow: hidden; position: relative; }
        .fng-fill { height: 100%; transition: width 1s; }
        .container { padding: 0 15px; max-width: 600px; margin: 0 auto; }
        .tabs { display: flex; background: #e4e6eb; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: bold; border-radius: 8px; color: #65676b; cursor: pointer; transition: 0.2s; }
        .tab.active { background: #fff; color: #1c1e21; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .coin-card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); position: relative; overflow: hidden; transition: transform 0.1s; }
        .coin-card:active { transform: scale(0.98); }
        .cc-header { display: flex; justify-content: space-between; align-items: center; }
        .cc-sym { font-size: 17px; font-weight: 800; }
        .cc-price { font-size: 13px; color: #65676b; }
        .cc-score-area { text-align: right; }
        .cc-badge { font-size: 11px; font-weight: bold; padding: 4px 10px; border-radius: 6px; color: white; display: inline-block; }
        .cc-detail { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; display: flex; justify-content: space-between; font-size: 12px; }
        .strategy-box { text-align: center; flex: 1; }
        .st-label { color: #888; font-size: 10px; display: block; margin-bottom: 2px; }
        .st-val { font-weight: bold; font-family: monospace; font-size: 13px; }
        .st-tp { color: var(--red); }
        .st-sl { color: var(--blue); }
        .pf-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 8px; border-left: 4px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .pf-item.plus { border-left-color: var(--red); }
        .pf-item.minus { border-left-color: var(--green); }
        .fab { position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px; background: #1877f2; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; box-shadow: 0 4px 15px rgba(24,119,242,0.4); cursor: pointer; z-index: 100; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .m-box { background: #fff; padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; background: #f7f8fa; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; font-size: 15px; margin-top: 5px; }
        .b-save { background: #1877f2; color: white; }
        .b-close { background: #f0f2f5; color: #65676b; margin-top: 10px; }
        .updated { text-align: right; font-size: 10px; opacity: 0.7; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="market-panel">
        <div style="font-size:18px; font-weight:bold; margin-bottom:15px;">Coincheck AI Final</div>
        <div class="mp-row">
            <div><div class="mp-label">BTCãƒˆãƒ¬ãƒ³ãƒ‰</div><div class="mp-val" id="btc-trend">---</div></div>
            <div style="text-align:right;"><div class="mp-label">å¸‚å ´å¿ƒç† (Fear&Greed)</div><div class="mp-val" id="fng-val">---</div></div>
        </div>
        <div class="fng-bar"><div class="fng-fill" id="fng-fill" style="width: 50%; background: #aaa;"></div></div>
        <div class="mp-label" style="text-align:right; margin-top:4px;" id="fng-state">---</div>
        <div class="updated" id="last-upd">æ›´æ–°ä¸­...</div>
    </div>
    <div class="container">
        <div class="tabs"><div class="tab active" id="t-short" onclick="chgMode('short')">çŸ­æœŸãƒˆãƒ¬ãƒ¼ãƒ‰</div><div class="tab" id="t-long" onclick="chgMode('long')">é•·æœŸä¿æœ‰</div></div>
        <div style="font-size:13px; font-weight:bold; color:#65676b; margin-bottom:10px;">è³‡ç”£çŠ¶æ³</div>
        <div id="pf-list"><div style="padding:20px; text-align:center; color:#999; font-size:12px;">ï¼‹ãƒœã‚¿ãƒ³ã§è¿½åŠ </div></div>
        <div style="font-size:13px; font-weight:bold; color:#65676b; margin:20px 0 10px;">AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ</div>
        <div id="m-list">Loading...</div>
    </div>
    <div class="fab" onclick="openM()">ï¼‹</div>
    <div class="modal" id="modal">
        <div class="m-box">
            <h3 style="text-align:center; margin-top:0;">è³‡ç”£å…¥åŠ›</h3>
            <label style="font-size:12px;">éŠ˜æŸ„</label><select id="in-sym"></select>
            <label style="font-size:12px;">è³¼å…¥å˜ä¾¡</label><input type="number" id="in-rate" placeholder="ä¾‹: 50">
            <label style="font-size:12px;">æŠ•è³‡é¡(å††)</label><input type="number" id="in-yen" placeholder="ä¾‹: 10000">
            <button class="b-save" onclick="save()">ä¿å­˜</button>
            <button class="b-close" onclick="closeM()">é–‰ã˜ã‚‹</button>
            <button onclick="delLast()" style="background:none; color:red; font-size:12px; margin-top:15px;">æœ€æ–°ã‚’å‰Šé™¤</button>
        </div>
    </div>
    <script>
        let mode = 'short';
        let data = {};
        let myPos = JSON.parse(localStorage.getItem('cc_final_pos')) || [];
        async function init() {
            try {
                const res = await fetch(`data/crypto_signal.json?t=${Date.now()}`);
                const json = await res.json();
                data = json.data;
                renderMarketInfo(json.market, json.updated);
                renderList();
                fillSel();
            } catch(e) { console.log(e); }
        }
        function renderMarketInfo(m, upd) {
            document.getElementById('last-upd').innerText = upd;
            const btcEl = document.getElementById('btc-trend');
            btcEl.innerText = m.btc_trend === "UP" ? "ä¸Šæ˜‡ (å¼·æ°—)" : "ä¸‹è½ (å¼±æ°—)";
            btcEl.style.color = m.btc_trend === "UP" ? "#eb4d3d" : "#007aff";
            document.getElementById('fng-val').innerText = m.fng_score;
            document.getElementById('fng-state').innerText = m.fng_state;
            const bar = document.getElementById('fng-fill');
            bar.style.width = m.fng_score + "%";
            if(m.fng_score <= 25) bar.style.background = "#007aff";
            else if(m.fng_score >= 75) bar.style.background = "#eb4d3d";
            else bar.style.background = "#f1c40f";
        }
        function chgMode(m) {
            mode = m;
            document.getElementById('t-short').className = `tab ${m==='short'?'active':''}`;
            document.getElementById('t-long').className = `tab ${m==='long'?'active':''}`;
            renderList();
        }
        function renderList() {
            const list = document.getElementById('m-list');
            const pfList = document.getElementById('pf-list');
            if(Object.keys(data).length > 0) {
                let html = '';
                const keys = Object.keys(data).sort((a,b) => data[b][mode].score - data[a][mode].score);
                keys.forEach(k => {
                    const d = data[k];
                    const a = d[mode];
                    html += `<div class="coin-card" onclick="pre('${k}')"><div class="cc-header"><div><div class="cc-sym">${k}</div><div class="cc-price">Â¥${d.price.toLocaleString()}</div></div><div class="cc-score-area"><div class="cc-badge" style="background:${a.color}">${a.signal}</div><div style="font-size:10px; color:#999; margin-top:2px;">SCORE: ${a.score}</div></div></div><div class="cc-detail"><div class="strategy-box" style="border-right:1px solid #eee;"><span class="st-label">æåˆ‡ã‚Š (S/L)</span><span class="st-val st-sl">Â¥${a.sl.toLocaleString()}</span></div><div class="strategy-box"><span class="st-label">åˆ©ç¢ºç›®æ¨™ (T/P)</span><span class="st-val st-tp">Â¥${a.tp.toLocaleString()}</span></div></div><div style="font-size:10px; color:#888; margin-top:8px; text-align:center;">${a.msg}</div></div>`;
                });
                list.innerHTML = html;
            }
            if(myPos.length > 0) {
                let html = '';
                myPos.forEach((p, i) => {
                    const d = data[p.symbol];
                    if(!d) return;
                    const val = (p.yen / p.buyRate) * d.price;
                    const profit = val - p.yen;
                    const cls = profit >= 0 ? 'plus' : 'minus';
                    let alert = '';
                    if(d[mode].score <= 30 && profit > 0) { alert = `<div style="width:100%; background:#06c755; color:white; font-size:10px; text-align:center; padding:2px; border-radius:4px; margin-top:4px;">ğŸš¨ åˆ©ç¢ºãƒãƒ£ãƒ³ã‚¹</div>`; }
                    html += `<div class="pf-item ${cls}"><div><div style="font-weight:bold; font-size:15px;">${p.symbol}</div><div style="font-size:11px; color:#888;">å–å¾—: ${p.buyRate}</div></div><div style="text-align:right;"><div style="font-weight:bold; font-size:16px; color:${profit>=0?'#ff3b30':'#007aff'}">${profit>=0?'+':''}Â¥${Math.floor(profit).toLocaleString()}</div>${alert}</div><button onclick="del(${i})" style="width:auto; padding:5px 10px; margin:0 0 0 10px; background:#f0f2f5; color:#333; font-size:10px;">Ã—</button></div>`;
                });
                pfList.innerHTML = html;
            } else { pfList.innerHTML = '<div style="text-align:center; padding:20px; font-size:12px; color:#999;">ï¼‹ãƒœã‚¿ãƒ³ã§è¿½åŠ </div>'; }
        }
        function fillSel(){ const s=document.getElementById('in-sym'); let h=''; Object.keys(data).forEach(k=>h+=`<option value="${k}">${k}</option>`); s.innerHTML=h; }
        function openM(){document.getElementById('modal').style.display='flex';}
        function closeM(){document.getElementById('modal').style.display='none';}
        function pre(s){document.getElementById('in-sym').value=s; openM();}
        function save(){
            const s=document.getElementById('in-sym').value; const r=document.getElementById('in-rate').value; const y=document.getElementById('in-yen').value;
            if(!s||!r||!y)return alert("å…¥åŠ›ä¸å‚™");
            myPos.push({symbol:s, buyRate:parseFloat(r), yen:parseFloat(y)}); localStorage.setItem('cc_final_pos', JSON.stringify(myPos)); closeM(); init();
        }
        function del(i){ if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){myPos.splice(i,1);localStorage.setItem('cc_final_pos',JSON.stringify(myPos));init();} }
        function delLast(){ if(myPos.length>0&&confirm("å‰Šé™¤ï¼Ÿ")){myPos.pop();localStorage.setItem('cc_final_pos',JSON.stringify(myPos));closeM();init();} }
        init();
    </script>
</body>
</html>
