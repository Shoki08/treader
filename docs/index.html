<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coincheck AI</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root {
            --bg: #f4f5f7; --text: #333; --card: #fff;
            --green: #00c076; --red: #ff4d4f; --blue: #1890ff;
            --gold: #faad14;
        }
        body {
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: var(--card); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        h1 { margin: 0; font-size: 18px; font-weight: 800; }
        .notify-btn {
            background: #eee; border: none; padding: 8px 12px;
            border-radius: 20px; font-size: 12px; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .notify-btn.active { background: var(--green); color: white; }

        /* ã‚¿ãƒ– */
        .tabs {
            display: flex; padding: 15px; gap: 10px; justify-content: center;
        }
        .tab {
            flex: 1; padding: 10px; text-align: center;
            border-radius: 12px; font-weight: bold; font-size: 14px;
            background: #e0e0e0; color: #666; cursor: pointer; transition: 0.2s;
        }
        .tab.active {
            background: #333; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .container { padding: 0 15px; max-width: 600px; margin: 0 auto; }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section-title {
            font-size: 16px; font-weight: 900; margin: 20px 0 10px;
            display: flex; align-items: center; gap: 8px;
        }
        .ranking-list { display: flex; flex-direction: column; gap: 10px; }

        .rank-card {
            background: var(--card); border-radius: 16px; padding: 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03); position: relative;
            overflow: hidden; cursor: pointer;
        }
        .rank-badge {
            position: absolute; top: 0; left: 0;
            background: #333; color: #fff; font-size: 10px; font-weight: bold;
            padding: 4px 10px 4px 8px; border-radius: 0 0 12px 0;
        }
        .rank-1 .rank-badge { background: var(--gold); color: #000; }
        .rank-2 .rank-badge { background: #bfbfbf; }
        .rank-3 .rank-badge { background: #cd7f32; }

        .rc-left { margin-left: 10px; }
        .rc-sym { font-size: 18px; font-weight: 800; }
        .rc-price { font-size: 12px; color: #888; }
        
        .rc-right { text-align: right; }
        .score-val { font-size: 22px; font-weight: 900; color: var(--text); }
        .score-lbl { font-size: 10px; color: #999; display: block; margin-top: -4px; }
        
        .signal-tag {
            font-size: 11px; font-weight: bold; padding: 4px 10px;
            border-radius: 6px; color: white; margin-top: 5px; display: inline-block;
        }

        /* è³‡ç”£ãƒªã‚¹ãƒˆ */
        .pf-card {
            background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px;
            border-left: 5px solid #ddd; position: relative;
        }
        .pf-card.plus { border-left-color: var(--red); }
        .pf-card.minus { border-left-color: var(--green); } /* ä»®æƒ³é€šè²¨ã¯èµ¤ãŒä¸Šã’ã€ç·‘ãŒä¸‹ã’ã®æ–‡åŒ–ãŒå¤šã„ãŒã€æ—¥æœ¬å¼ã«åˆã‚ã›ã‚‹ãªã‚‰èµ¤å­—=ãƒ—ãƒ©ã‚¹ */
        
        .del-btn {
            position: absolute; top: 10px; right: 10px;
            background: #f5f5f5; border: none; padding: 5px 10px;
            border-radius: 20px; font-size: 10px; color: #999;
        }

        /* æ›´æ–°æ—¥æ™‚ */
        .updated-time { text-align: center; font-size: 11px; color: #999; margin-top: 20px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .fab {
            position: fixed; bottom: 25px; right: 25px;
            width: 60px; height: 60px; background: #333; color: #fff;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 99;
        }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #fff; width: 85%; max-width: 320px; padding: 25px; border-radius: 20px;
        }
        input, select {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #eee; border-radius: 10px; background: #f9f9f9;
            font-size: 16px; box-sizing: border-box;
        }
        button.save { width: 100%; padding: 12px; background: #333; color: #fff; border: none; border-radius: 10px; font-weight: bold; font-size: 15px; }
        button.close { background: none; border: none; color: #999; margin-top: 10px; width: 100%; font-size: 13px; }

    </style>
</head>
<body>

    <header>
        <h1>Coincheck AI</h1>
        <button id="notifyBtn" class="notify-btn" onclick="reqNotify()">
            ğŸ”” é€šçŸ¥OFF
        </button>
    </header>

    <div class="tabs">
        <div class="tab active" id="t-short" onclick="setMode('short')">âš¡ï¸ ãƒ‡ã‚¤ãƒˆãƒ¬ (çŸ­æœŸ)</div>
        <div class="tab" id="t-long" onclick="setMode('long')">ğŸ’ ã‚¬ãƒãƒ› (é•·æœŸ)</div>
    </div>

    <div class="container">
        <div class="section-title">ğŸ† AIæ¨å¥¨ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP5</div>
        <div id="ranking-area" class="ranking-list">
            <div style="text-align:center; padding:40px; color:#999;">åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="section-title" style="margin-top:30px;">ğŸ’° ã‚ãªãŸã®è³‡ç”£</div>
        <div id="pf-area">
            <div style="text-align:center; padding:20px; font-size:12px; color:#999; background:#fff; border-radius:12px;">
                ã¾ã è³¼å…¥æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã¦è³¼å…¥ã—ãŸã‚‰ã€å³ä¸‹ã®ï¼‹ãƒœã‚¿ãƒ³ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
            </div>
        </div>

        <div class="updated-time" id="last-upd">---</div>
    </div>

    <div class="fab" onclick="openModal()">ï¼‹</div>

    <div class="modal" id="modal">
        <div class="modal-box">
            <h3 style="text-align:center; margin-top:0;">è³‡ç”£ã‚’ç™»éŒ²</h3>
            <label style="font-size:12px; color:#888;">è³¼å…¥ã—ãŸéŠ˜æŸ„</label>
            <select id="in-sym"></select>
            <label style="font-size:12px; color:#888;">è³¼å…¥ãƒ¬ãƒ¼ãƒˆ(1æšã‚ãŸã‚Š)</label>
            <input type="number" id="in-rate" placeholder="ä¾‹: 5000000">
            <label style="font-size:12px; color:#888;">è³¼å…¥é‡‘é¡(å††)</label>
            <input type="number" id="in-yen" placeholder="ä¾‹: 10000">
            <button class="save" onclick="saveData()">ä¿å­˜ã™ã‚‹</button>
            <button class="close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        let mode = 'short'; // short or long
        let marketData = {};
        let myPos = JSON.parse(localStorage.getItem('cc_v6_pos')) || [];

        // é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        function reqNotify() {
            if (!("Notification" in window)) return alert("ã“ã®ç«¯æœ«ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
            Notification.requestPermission().then(permission => {
                updateNotifyBtn(permission);
                if (permission === "granted") new Notification("é€šçŸ¥ãŒã‚ªãƒ³ã«ãªã‚Šã¾ã—ãŸï¼");
            });
        }

        function updateNotifyBtn(perm) {
            const btn = document.getElementById('notifyBtn');
            if (perm === 'granted') {
                btn.innerText = "ğŸ”” é€šçŸ¥ON";
                btn.classList.add('active');
            } else {
                btn.innerText = "ğŸ”• é€šçŸ¥OFF";
                btn.classList.remove('active');
            }
        }

        // åˆæœŸåŒ–
        async function init() {
            if ("Notification" in window) updateNotifyBtn(Notification.permission);
            
            try {
                const ts = new Date().getTime();
                const res = await fetch(`data/crypto_signal.json?t=${ts}`);
                const json = await res.json();
                marketData = json.data;
                document.getElementById('last-upd').innerText = `ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${json.updated}`;
                
                fillSelect();
                render();
            } catch (e) {
                console.error(e);
                document.getElementById('ranking-area').innerHTML = '<div style="text-align:center; padding:20px;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼<br>ã¾ã åˆ†æãŒå®Œäº†ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</div>';
            }
        }

        function setMode(m) {
            mode = m;
            document.getElementById('t-short').className = `tab ${m==='short'?'active':''}`;
            document.getElementById('t-long').className = `tab ${m==='long'?'active':''}`;
            render();
        }

        function render() {
            if (Object.keys(marketData).length === 0) return;

            // --- 1. ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆ ---
            const list = document.getElementById('ranking-area');
            // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedKeys = Object.keys(marketData).sort((a, b) => {
                const scoreA = marketData[a][mode].score || 0;
                const scoreB = marketData[b][mode].score || 0;
                return scoreB - scoreA;
            });

            let html = '';
            // ä¸Šä½5ã¤ã‚’è¡¨ç¤º
            sortedKeys.slice(0, 5).forEach((sym, idx) => {
                const d = marketData[sym];
                const a = d[mode];
                
                // ãƒ©ãƒ³ã‚¯ã”ã¨ã®ã‚¹ã‚¿ã‚¤ãƒ«
                const rankClass = idx < 3 ? `rank-${idx+1}` : '';
                
                html += `
                <div class="rank-card ${rankClass}" onclick="prefill('${sym}')">
                    <div class="rank-badge">${idx + 1}ä½</div>
                    <div class="rc-left">
                        <div class="rc-sym">${sym}</div>
                        <div class="rc-price">Â¥${d.price.toLocaleString()}</div>
                        <div class="signal-tag" style="background:${a.color}">${a.signal}</div>
                    </div>
                    <div class="rc-right">
                        <div class="score-val" style="color:${a.color}">${a.score}</div>
                        <span class="score-lbl">AIã‚¹ã‚³ã‚¢</span>
                    </div>
                </div>`;
            });
            list.innerHTML = html;

            // --- 2. è³‡ç”£ãƒªã‚¹ãƒˆç”Ÿæˆ ---
            const pfList = document.getElementById('pf-area');
            if (myPos.length > 0) {
                let pfHtml = '';
                myPos.forEach((p, i) => {
                    const d = marketData[p.symbol];
                    if (!d) return;
                    
                    const currentVal = (p.yen / p.buyRate) * d.price;
                    const profit = currentVal - p.yen;
                    const cls = profit >= 0 ? 'plus' : 'minus';
                    const sign = profit >= 0 ? '+' : '';

                    // å£²ã‚Šé€šçŸ¥ãƒã‚§ãƒƒã‚¯
                    const score = d[mode].score;
                    let alertMsg = '';
                    if (score <= 30 && profit > 0) {
                        alertMsg = `<div style="color:#fff; background:#00c076; font-size:11px; padding:4px; text-align:center; border-radius:4px; margin-top:5px; font-weight:bold;">ğŸš¨ AIåˆ¤æ–­: åˆ©ç›Šç¢ºå®šã®å¥½æ©Ÿ</div>`;
                        // é€šçŸ¥è¨±å¯æ¸ˆã¿ãªã‚‰é€šçŸ¥ã‚’é€ã‚‹
                        if (Notification.permission === "granted") {
                            // é€£ç¶šé€šçŸ¥ã‚’é˜²ããŸã‚ç°¡æ˜“çš„ãªåˆ¶å¾¡ã‚’å…¥ã‚Œã‚‹ç­‰ã®å·¥å¤«ãŒå¯èƒ½ã ãŒã€ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«
                        }
                    }

                    pfHtml += `
                    <div class="pf-card ${cls}">
                        <button class="del-btn" onclick="delPos(${i})">å‰Šé™¤</button>
                        <div style="font-weight:bold; font-size:16px;">${p.symbol}</div>
                        <div style="font-size:12px; color:#888; margin-bottom:5px;">æŠ•è³‡: Â¥${p.yen.toLocaleString()} (Â¥${p.buyRate}/æš)</div>
                        <div style="font-weight:900; font-size:18px; color:${profit>=0?'#ff4d4f':'#00c076'}">
                            ${sign}Â¥${Math.floor(profit).toLocaleString()}
                        </div>
                        ${alertMsg}
                    </div>`;
                });
                pfList.innerHTML = pfHtml;
            } else {
                pfList.innerHTML = `<div style="text-align:center; padding:20px; font-size:12px; color:#999; background:#fff; border-radius:12px;">ã¾ã è³¼å…¥æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã¦è³¼å…¥ã—ãŸã‚‰ã€å³ä¸‹ã®ï¼‹ãƒœã‚¿ãƒ³ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>`;
            }
        }

        // UIæ“ä½œç³»
        function fillSelect() {
            const s = document.getElementById('in-sym');
            let h = '';
            Object.keys(marketData).sort().forEach(k => h += `<option value="${k}">${k}</option>`);
            s.innerHTML = h;
        }
        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function prefill(sym) {
            document.getElementById('in-sym').value = sym;
            openModal();
        }
        function saveData() {
            const s = document.getElementById('in-sym').value;
            const r = document.getElementById('in-rate').value;
            const y = document.getElementById('in-yen').value;
            if (!s || !r || !y) return alert("å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            myPos.push({ symbol: s, buyRate: parseFloat(r), yen: parseFloat(y) });
            localStorage.setItem('cc_v6_pos', JSON.stringify(myPos));
            closeModal(); render();
        }
        function delPos(i) {
            if (confirm("ã“ã®è³‡ç”£ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                myPos.splice(i, 1);
                localStorage.setItem('cc_v6_pos', JSON.stringify(myPos));
                render();
            }
        }

        init();
    </script>
</body>
</html>